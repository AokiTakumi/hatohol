{% extends "viewer/base_ajax.html" %}
{% load i18n %}

{% comment %}
  Copyright (C) 2013 Project Hatohol

  This file is part of Hatohol.

  Hatohol is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 2 of the License, or
  (at your option) any later version.

  Hatohol is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with Hatohol. If not, see <http://www.gnu.org/licenses/>.
{% endcomment %}

{% block navbar %}
{% endblock %}

{% block main %}
  <h2>{% trans "Servers" %}</h2>

  <form class="form-inline">
    <input id="add-server-button" type="button" class="btn" value="{% trans "ADD SERVER" %}" />
    <input id="delete-server-button" type="button" class="btn" disabled
      value="{% trans "DELETE SERVER" %}" />
  </form>

  <div id="msgbox" title="Message Box">
    <p id="msgbox-text"></p>
  </div>

  <form id="add-server-form", method="POST"> {% csrf_token %}
  </form>

  <table class="table table-condensed table-striped table-hover" id="table">
    <thead>
      <tr>
        <th> </th>
        <th>{% trans "ID" %}</th>
        <th>{% trans "Type" %}</th>
        <th>{% trans "Hostname" %}</th>
        <th>{% trans "IP Address" %}</th>
        <th>{% trans "Nickname" %}</th>
        <th>{% trans "Maps" %}</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
{% endblock %}

{% block option %}
  <script src="{{ STATIC_URL }}js/hatohol_server_edit_dialog.js"></script>
{% endblock %}

{% block logic %}
  <script type="text/javascript">

    var numSelected = 0;

    $("#add-server-button").click(function() {
      new HatoholServerEditDialog(addSucceededCb);
    });

    $("#delete-server-button").click(function() {
      alert("Not implemented yet.");
    });

    function addSucceededCb() {
      startConnection('server', updateCore);
    };

    function setupCheckboxHandler() {
      $(".selectcheckbox").change(function() {
        check = $(this).is(":checked");
        var prevNumSelected = numSelected;
        if (check)
          numSelected += 1;
        else
          numSelected -= 1;
        if (prevNumSelected == 0 && numSelected == 1)
          $("#delete-server-button").attr("disabled", false);
        else if (prevNumSelected == 1 && numSelected == 0)
          $("#delete-server-button").attr("disabled", true);
      });
    }

    function parseResult(data) {
      var msg;
      var malformed =false;
      if (data.result == undefined)
        malformed = true;
      if (!malformed && !data.result && data.message == undefined)
        malformed = true;
      if (malformed) {
        msg = "The returned content is malformed: " +
              "Not found 'result' or 'message'.\n" +
              JSON.stringify(data);
        hatoholErrorMsgBox(msg);
        return false;
      }
      if (!data.result) {
        msg = "Failed:\n" + data.message;
        hatoholErrorMsgBox(msg);
        return false;
      }
      if (data.id == undefined) {
        msg = "The returned content is malformed: " +
              "'result' is true, however, 'id' missing.\n" +
              JSON.stringfy(data);
        hatoholErrorMsgBox(msg);
        return false;
      }
      return true;
    }

    function deleteServers() {
      $(this).dialog("close");
      checkbox = $(".selectcheckbox");
      var deletedIdArray = {count:0, total:0, errors:0};
      for (var i = 0; i < checkbox.length; i++) {
        if (!checkbox[i].checked)
          continue;
        var serverId = checkbox[i].getAttribute("serverId");
        deletedIdArray[serverId] = true;
        deletedIdArray.count++;
        deletedIdArray.total++;
        deleteOneServer(serverId, deletedIdArray);
      }
      hatoholInfoMsgBox("{% trans "Deleting..." %}");
    }

    function deleteOneServer(id, deletedIdArray) {
      new HatoholConnector({
        url: '/server/' + id,
        request: "DELETE",
        context: deletedIdArray,
        replyCallBack: function(data, parser, context) {
          parseDeleteServerResult(data, context);
        },
        connectErrorCallback: function(XMLHttpRequest,
                                       textStatus, errorThrown) {
          var errorMsg = "Error: " + XMLHttpRequest.status + ": " +
                         XMLHttpRequest.statusText;
          hatoholErrorMsgBox(errorMsg);
          deletedIdArray.errors++;
        },
        completionCallback: function(context) {
          completeOneDelServer(context);
        }
      });
    }

    function parseDeleteServerResult(data, deletedIdArray) {
      if (parseResult(data))
        return;
      if (!(data.id in deletedIdArray)) {
        alert("Fatal Error: You should reload page.\nID: " + data.id +
              " is not in deletedIdArray: " + deletedIdArray);
        deletedIdArray.errors++;
        return;
      }
      delete deletedIdArray[data.id];
    }

    function completeOneDelServer(deletedIdArray) {
      deletedIdArray.count--;
      var completed = deletedIdArray.total - deletedIdArray.count;
      hatoholErrorMsgBox("{% trans "Deleting..." %}" + " " + completed +
                         " / " + deletedIdArray.total);
      if (deletedIdArray.count > 0)
        return;

      hatoholInfoMsgBox("{% trans " Completed. (Number of errors: " %}" +
                        deletedIdArray.errors + ")");
      startConnection('server', updateCore);
    }

    function drawTableBody(rd) {
      var x;
      var s;
      var o;
      var ip, serverURL, mapsURL;

      s = "";
      for (x = 0; x < rd["servers"].length; ++x) {
        o = rd["servers"][x];
        ip = o["ipAddress"];
        serverURL = getServerLocation(o);
        mapsURL = getMapsLocation(o);
        s += "<tr>";
        s += "<td><input type='checkbox' class='selectcheckbox' " +
             "serverId='" + o["id"] + "'></td>";
        s += "<td>" + o["id"] + "</td>";
        s += "<td>" + o["type"]  + "</td>";
        if (serverURL) {
          s += "<td><a href='" + serverURL + "'>" + o["hostName"]  + "</a></td>";
          s += "<td><a href='" + serverURL + "'>" + ip + "</a></td>";
        } else {
          s += "<td>" + o["hostName"]  + "</td>";
          s += "<td>" + ip + "</td>";
        }
        s += "<td>" + o["nickname"]  + "</td>";
        if (mapsURL) {
          s += "<td><a href='" + mapsURL + "'>" + "{% trans 'Maps' %}" + "</a></td>";
        } else {
          s += "<td></td>";
        }
        s += "</tr>";
      }

      return s;
    }

    function updateCore(reply) {
      $("#table tbody").empty();
      $("#table tbody").append(drawTableBody(reply));
      setupCheckboxHandler();
      numSelected = 0;
    }

    new HatoholNavi();
    startConnection('server', updateCore);
  </script>
{% endblock %}
